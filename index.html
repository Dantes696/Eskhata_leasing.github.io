<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Калькулятор рассрочки</title>

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif}
body{background:linear-gradient(135deg,#f5f7fa 0%,#c3cfe2 100%);min-height:100vh;padding:20px;display:flex;justify-content:center;align-items:flex-start}
.container{background:#fff;border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,.15);padding:40px;max-width:1200px;width:100%;margin-top:20px}
h1{text-align:center;margin-bottom:30px;font-size:32px;color:#2c3e50}
.calculator-section{display:flex;flex-wrap:wrap;gap:40px}
.input-section{flex:1;min-width:350px;padding:25px;background:#f8f9fa;border-radius:15px}
.output-section{flex:2;min-width:500px}
.input-group{margin-bottom:20px}
label{display:block;margin-bottom:8px;font-weight:600;font-size:14px;color:#495057}
.currency-input,.percentage-input{position:relative}
.currency-input input,.percentage-input input,input[type=number],select{width:100%;padding:12px 15px;border:2px solid #e0e0e0;border-radius:8px;font-size:16px}
.currency-input input{padding-left:45px}
.percentage-input input{padding-right:45px}
.currency-symbol{position:absolute;left:15px;top:50%;transform:translateY(-50%);font-weight:bold}
.percentage-symbol{position:absolute;right:15px;top:50%;transform:translateY(-50%);font-weight:bold}
.calculate-btn{width:100%;padding:16px;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border:none;border-radius:10px;font-size:18px;font-weight:600;cursor:pointer}
.summary-section{background:#fff;border-radius:15px;padding:25px;margin-bottom:30px}
.summary-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px}
.summary-item{text-align:center;padding:20px;background:#f8f9fa;border-radius:10px}
.summary-label{font-size:14px;color:#6c757d;margin-bottom:8px}
.summary-value{font-size:24px;font-weight:700;color:#2c3e50}
.results-container{background:#fff;border-radius:15px;padding:25px}
.schedule-container{max-height:400px;overflow:auto;border:2px solid #e9ecef;border-radius:10px}
table{width:100%;border-collapse:collapse;font-size:14px}
thead{position:sticky;top:0;background:#2c3e50;color:#fff}
th,td{padding:10px;text-align:center}
tbody tr:nth-child(even){background:#fafafa}
</style>
</head>

<body>
<div class="container">
<h1>Калькулятор рассрочки</h1>

<div class="calculator-section">
<div class="input-section">

<div class="input-group">
<label>Стоимость имущества (UZS)</label>
<div class="currency-input">
<span class="currency-symbol">UZS</span>
<input type="text" id="price" value="265 000 000">
</div>
</div>

<div class="input-group">
<label>Аванс (%)</label>
<div class="percentage-input">
<input type="text" id="advance" value="30">
<span class="percentage-symbol">%</span>
</div>
</div>

<div class="input-group">
<label>Срок (мес.)</label>
<input type="number" id="term" value="6" min="1">
</div>

<div class="input-group">
<label>Доп. платёж (UZS)</label>
<div class="currency-input">
<span class="currency-symbol">UZS</span>
<input type="text" id="extra" value="0">
</div>
</div>

<div class="input-group">
<label>Тип графика</label>
<select id="type">
<option value="annuity">Аннуитет</option>
<option value="decl2">Убывающий 2x</option>
<option value="decl3">Убывающий 3x</option>
<option value="linear_q">Линейный (квартальный)</option>
<option value="inst_m">Рассрочка ежемесячная</option>
<option value="inst_q">Рассрочка квартальная</option>
</select>
</div>

<button class="calculate-btn" onclick="build()">Рассчитать</button>

</div>

<div class="output-section">

<div class="summary-section">
<div class="summary-grid">
<div class="summary-item"><div class="summary-label">Сумма лизинга</div><div class="summary-value" id="outLease">0</div></div>
<div class="summary-item"><div class="summary-label">Аванс</div><div class="summary-value" id="outAdvance">0</div></div>
<div class="summary-item"><div class="summary-label">Переплата</div><div class="summary-value" id="outOver">0</div></div>
<div class="summary-item"><div class="summary-label">Платёж 1</div><div class="summary-value" id="outPay">0</div></div>
</div>
</div>

<div class="results-container">
<div class="schedule-container">
<table>
<thead>
<tr><th>Мес</th><th>Платёж</th><th>Тело</th><th>%</th><th>Остаток</th></tr>
</thead>
<tbody id="tbl"></tbody>
</table>
</div>
</div>

</div>
</div>
</div>

<script>
const REG = 876736;
const MONTHLY_RATE = 0.2975 / 12;

function parseNum(v){
v=String(v).replace(/\s|\u00A0/g,'').replace(',','.');
let x=parseFloat(v);
return isNaN(x)?0:x;
}

function formatNum(x){
x=Math.round(x*100)/100;
let p=x.toString().split('.');
p[0]=p[0].replace(/\B(?=(\d{3})+(?!\d))/g,' ');
return p.length===1?p[0]+'.00':p[1].length===1?p[0]+'.'+p[1]+'0':p.join('.');
}

function annuity(amount,rate,term){
let res=[],bal=amount;
let pay=amount*(rate*Math.pow(1+rate,term))/(Math.pow(1+rate,term)-1);
for(let i=1;i<=term;i++){
let intr=bal*rate;
let pr=Math.min(bal,Math.max(0,pay-intr));
bal-=pr;
res.push([i,pay,pr,intr,Math.max(0,bal)]);
}
return res;
}

function declining(amount,rate,term,ratio){
let ann=amount*(rate*Math.pow(1+rate,term))/(Math.pow(1+rate,term)-1);
let first=ann*1.5;
let last=first/ratio;
let dec=(term>1)?(first-last)/(term-1):0;
let best=first,bestErr=amount;

for(let it=0;it<200;it++){
let bal=amount,ok=true;
for(let i=1;i<=term;i++){
let cur=first-(i-1)*dec;
let intr=bal*rate;
let pr=cur-intr;
if(pr<=0){ok=false;break}
bal-=pr;
}
if(ok){
if(Math.abs(bal)<Math.abs(bestErr)){bestErr=bal;best=first}
if(Math.abs(bal)<amount*1e-6)break;
first*=bal>0?1.001:0.999;
}else{
first*=1.001;
}
last=first/ratio;
dec=(term>1)?(first-last)/(term-1):0;
}

first=best;
last=first/ratio;
dec=(term>1)?(first-last)/(term-1):0;

let res=[],bal=amount;
for(let i=1;i<=term;i++){
let pay=first-(i-1)*dec;
let intr=bal*rate;
let pr;
if(i===term){
pr=bal;
pay=pr+intr;
bal=0;
}else{
pr=pay-intr;
if(pr<0)pr=0;
if(pr>bal)pr=bal;
bal-=pr;
}
res.push([i,pay,pr,intr,Math.max(0,bal)]);
}
return res;
}

function linearQuarterly(amount,rate,term){
let res=[],bal=amount;
let quarters=Math.floor((term+2)/3);
let prQ=amount/quarters;

for(let i=1;i<=term;i++){
let intr=bal*rate;
if(i%3===0||i===term){
let pr=i===term?bal:prQ;
let pay=pr+intr*3;
bal-=pr;
res.push([i,pay,pr,intr,Math.max(0,bal)]);
}else{
res.push([i,null,null,intr,bal]);
}
}
return res;
}

function installment(amount,term,quarter){
let res=[],bal=amount,per=amount/term,acc=0;
for(let i=1;i<=term;i++){
let p=i===term?bal:per;
bal-=p;
if(quarter){
acc+=p;
if(i%3===0||i===term){
res.push([i,acc,acc,0,Math.max(0,bal)]);
acc=0;
}else{
res.push([i,null,null,null,null]);
}
}else{
res.push([i,p,p,0,Math.max(0,bal)]);
}
}
return res;
}

function build(){
let P=parseNum(price.value);
let A=parseNum(advance.value)/100;
let T=parseInt(term.value);
let E=parseNum(extra.value);

let total=P+REG;
let adv=total*A;
let lease=total-adv;

let sch=[];
switch(type.value){
case'annuity':sch=annuity(lease,MONTHLY_RATE,T);break;
case'decl2':sch=declining(lease,MONTHLY_RATE,T,2);break;
case'decl3':sch=declining(lease,MONTHLY_RATE,T,3);break;
case'linear_q':sch=linearQuarterly(lease,MONTHLY_RATE,T);break;
case'inst_m':sch=installment(lease,T,false);break;
case'inst_q':sch=installment(lease,T,true);break;
}

let over=0;
tbl.innerHTML='';
sch.forEach(r=>{
if(r[3]) over+=r[3];
let pay=(r[1]!==null)?r[1]+E:null;
let tr=document.createElement('tr');
tr.innerHTML=`<td>${r[0]}</td>
<td>${pay!==null?formatNum(pay):'-'}</td>
<td>${r[2]!=null?formatNum(r[2]):'-'}</td>
<td>${r[3]!=null?formatNum(r[3]):'-'}</td>
<td>${r[4]!=null?formatNum(r[4]):'-'}</td>`;
tbl.appendChild(tr);
});

outLease.textContent=formatNum(lease);
outAdvance.textContent=formatNum(adv);
outOver.textContent=formatNum(over);
outPay.textContent=sch[0][1]?formatNum(sch[0][1]+E):'0';
}

document.querySelectorAll('.currency-input input').forEach(i=>{
i.addEventListener('input',()=>{
let v=parseNum(i.value);
if(v||i.value==='0') i.value=v.toLocaleString('ru-RU');
});
});

build();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Калькулятор рассрочки</title>
    <style>
        /* ========== CSS СТИЛИ ========== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.15);
            padding: 40px;
            max-width: 1200px;
            width: 100%;
            margin-top: 20px;
        }

        h1 {
            color: #2c3e50;
            margin-bottom: 30px;
            text-align: center;
            font-size: 32px;
            font-weight: 700;
        }

        .calculator-section {
            display: flex;
            flex-wrap: wrap;
            gap: 40px;
            margin-bottom: 20px;
        }

        .input-section {
            flex: 1;
            min-width: 350px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
        }

        .output-section {
            flex: 2;
            min-width: 500px;
        }

        .input-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #495057;
            font-weight: 600;
            font-size: 14px;
        }

        .currency-input, .percentage-input {
            position: relative;
        }

        .currency-input input, .percentage-input input, input[type="number"], select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
            background: white;
        }

        .currency-input input {
            padding-left: 45px;
        }

        .percentage-input input {
            padding-right: 45px;
        }

        .currency-symbol {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
            font-weight: bold;
            font-size: 14px;
        }

        .percentage-symbol {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
            font-weight: bold;
            font-size: 14px;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .calculate-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            margin-top: 10px;
        }

        .calculate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .calculate-btn:active {
            transform: translateY(0);
        }

        .summary-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08);
            margin-bottom: 30px;
        }

        .summary-section h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 24px;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .summary-item {
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 1px solid #e9ecef;
            transition: transform 0.3s;
        }

        .summary-item:hover {
            transform: translateY(-5px);
        }

        .summary-label {
            color: #6c757d;
            font-size: 14px;
            margin-bottom: 10px;
            font-weight: 500;
        }

        .summary-value {
            font-size: 24px;
            font-weight: 700;
            color: #2c3e50;
        }

        .summary-value.uzs::after {
            content: " UZS";
            font-size: 0.7em;
            color: #6c757d;
        }

        .summary-value.percent::after {
            content: "%";
            font-size: 0.7em;
            color: #6c757d;
        }

        .irr-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #e9ecef;
        }

        .irr-section h3 {
            color: #495057;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .results-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08);
        }

        .results-container h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 20px;
        }

        .schedule-container {
            max-height: 400px;
            overflow-y: auto;
            border: 2px solid #e9ecef;
            border-radius: 10px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        thead {
            position: sticky;
            top: 0;
            background: #2c3e50;
            color: white;
        }

        th {
            padding: 15px 12px;
            text-align: center;
            font-weight: 600;
            font-size: 13px;
        }

        td {
            padding: 12px 10px;
            text-align: center;
            border-bottom: 1px solid #eee;
            font-family: 'Courier New', monospace;
        }

        tbody tr:hover {
            background: #f8f9fa;
        }

        tbody tr:nth-child(even) {
            background: #fcfcfc;
        }

        .loader {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loader.active {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none !important;
        }

        .warning {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .calculator-section {
                flex-direction: column;
            }
            
            .input-section, .output-section {
                min-width: 100%;
            }
            
            .summary-grid {
                grid-template-columns: 1fr 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Калькулятор рассрочки</h1>
        
        <div class="calculator-section">
            <div class="input-section">
                <div class="input-group">
                    <label>Стоимость имущества (UZS)</label>
                    <div class="currency-input">
                        <span class="currency-symbol">UZS</span>
                        <input type="text" id="totalPrice" placeholder="Введите цену актива" value="10 000 000">
                    </div>
                </div>
                
                <div class="input-group">
                    <label>Авансовый платеж (%)</label>
                    <div class="percentage-input">
                        <input type="text" id="advancePercent" placeholder="Введите авансовый платеж" value="30">
                        <span class="percentage-symbol">%</span>
                    </div>
                </div>
                
                <div class="input-group">
                    <label>Скрытая скидка (UZS)</label>
                    <div class="currency-input">
                        <span class="currency-symbol">UZS</span>
                        <input type="text" id="discount" placeholder="Введите скрытую скидку" value="0">
                    </div>
                </div>
                
                <div class="input-group">
                    <label>Запрашиваемый период рассрочки (месяцы)</label>
                    <input type="number" id="requestedMonths" placeholder="Введите желаемое количество месяцев" value="12" min="3" max="13">
                </div>
                
                <div class="input-group">
                    <label>Срок лизинга (месяцев)</label>
                    <input type="number" id="term" placeholder="Введите срок" value="36" min="1" max="120">
                </div>
                
                <div class="input-group">
                    <label>Дополнительный ежемесячный платеж (UZS)</label>
                    <div class="currency-input">
                        <span class="currency-symbol">UZS</span>
                        <input type="text" id="extraPayment" placeholder="Введите дополнительный платеж" value="0">
                    </div>
                </div>
                
                <div class="input-group">
                    <label>Тип графика платежей</label>
                    <select id="paymentType">
                        <option value="annuity">Аннуитет (Лизинг/Финаренда)</option>
                        <option value="linear">Линейный</option>
                        <option value="declining2x">Убывающий 2x</option>
                        <option value="declining3x">Убывающий 3x</option>
                        <option value="quarterly_annuity">Ежеквартальный аннуитет</option>
                        <option value="quarterly_linear">Ежеквартальный линейный</option>
                        <option value="installment_monthly" selected>Рассрочка ежемесячная</option>
                        <option value="installment_quarterly">Рассрочка квартальная</option>
                    </select>
                </div>
                
                <button class="calculate-btn" id="calculateBtn">Рассчитать рассрочку</button>
                
                <div class="loader" id="loader">
                    <div class="spinner"></div>
                    <p>Идет расчет...</p>
                </div>
            </div>
            
            <div class="output-section">
                <div class="summary-section">
                    <h2>Результаты расчета</h2>
                    <div class="summary-grid">
                        <div class="summary-item">
                            <div class="summary-label">Сумма лизинга</div>
                            <div class="summary-value uzs" id="leasingAmount">0</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">Аванс</div>
                            <div class="summary-value uzs" id="advanceAmount">0</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">Общая переплата</div>
                            <div class="summary-value uzs" id="totalOverpayment">0</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">Эффективная ставка</div>
                            <div class="summary-value percent" id="effectiveRate">0</div>
                        </div>
                    </div>
                    
                    <div class="irr-section hidden" id="irrSection">
                        <h3>Анализ IRR</h3>
                        <div class="summary-grid">
                            <div class="summary-item">
                                <div class="summary-label">Месячный IRR</div>
                                <div class="summary-value percent" id="monthlyIRR">0</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-label">Годовой IRR</div>
                                <div class="summary-value percent" id="annualIRR">0</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="results-container">
                    <h3>График платежей</h3>
                    <div class="schedule-container">
                        <table id="paymentSchedule">
                            <thead>
                                <tr>
                                    <th>Месяц</th>
                                    <th>Платеж (UZS)</th>
                                    <th>Основной долг</th>
                                    <th>Проценты</th>
                                    <th>Остаток долга</th>
                                </tr>
                            </thead>
                            <tbody id="scheduleBody">
                                <tr><td colspan="5">Нажмите "Рассчитать рассрочку" для отображения графика</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========== СКРЫТЫЕ ПАРАМЕТРЫ АДМИНИСТРАТОРА ==========
        // Эти параметры используются в расчетах, но не показываются пользователю
        // Для изменения параметров редактируйте значения ниже:
        
        const HIDDEN_ADMIN_PARAMS = {
            // Ставка лизинга: 29.75% годовых (фиксировано)
            leasingRate: 0.2975,
            
            // Страховая ставка: 0.24% годовых (изменено)
            insuranceRate: 0.0024,
            
            // Маржа: 3% годовых (изменено)
            marginRate: 0.03,
            
            // Коэффициент для убывающих платежей
            decliningRatio: 1.5,
            
            // Ставка НДС для скрытой скидки
            vatRate: 0.12
        };

        // ========== ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ ==========
        // Форматирование чисел с пробелами (10 000 000)
        function formatNumber(num) {
            return new Intl.NumberFormat('ru-RU').format(Math.round(num));
        }

        // Парсинг форматированных чисел
        function parseFormattedNumber(str) {
            if (!str || str === '') return 0;
            const cleaned = String(str).replace(/\s/g, '').replace(',', '.');
            const num = parseFloat(cleaned);
            return isNaN(num) ? 0 : num;
        }

        // Нормализация процентов
        function normalizePercent(value) {
            if (typeof value === 'number') {
                if (value >= 0 && value < 1) return value;
                if (value >= 1) return value / 100;
            }
            
            let str = String(value);
            str = str.replace(/%/g, '')
                    .replace(/\s/g, '')
                    .replace(/,/g, '.')
                    .trim();
            
            if (!str) return 0;
            
            const num = parseFloat(str);
            if (isNaN(num)) return 0;
            
            return (num >= 0 && num < 1) ? num : num / 100;
        }

        // ========== КАЛЬКУЛЯТОР IRR ==========
        function calculateIRR(cashFlows, guess = 0.1) {
            const maxIterations = 1000;
            const tolerance = 0.000001;
            
            for (let i = 0; i < maxIterations; i++) {
                let npv = 0;
                let dnpv = 0;
                
                for (let j = 0; j < cashFlows.length; j++) {
                    npv += cashFlows[j] / Math.pow(1 + guess, j);
                    dnpv -= j * cashFlows[j] / Math.pow(1 + guess, j + 1);
                }
                
                if (Math.abs(dnpv) < 1e-10) break;
                
                const newGuess = guess - npv / dnpv;
                if (Math.abs(newGuess - guess) < tolerance) return newGuess;
                guess = newGuess;
            }
            return guess;
        }

        function analyzeIRR(price, advance, discount, months, monthlyPayment) {
            const adjustedDiscount = discount * (100 / (100 + HIDDEN_ADMIN_PARAMS.vatRate * 100));
            const initialOutflow = -price + adjustedDiscount + advance;
            const cashFlows = [initialOutflow];
            
            for (let i = 0; i < months; i++) {
                cashFlows.push(monthlyPayment);
            }
            
            const monthlyIRR = calculateIRR(cashFlows);
            return {
                monthlyIRR,
                annualIRR: monthlyIRR * 12,
                cashFlows
            };
        }

        // ========== ФУНКЦИИ ЛИЗИНГА ==========
        function calcAnnuity(amount, rate, term) {
            if (term <= 0 || amount <= 0) return [];
            
            const schedule = [];
            let balance = amount;
            
            if (Math.abs(rate) < 1e-12) {
                const payment = amount / term;
                for (let i = 1; i <= term; i++) {
                    const principal = (i === term) ? balance : payment;
                    const interest = balance * rate;
                    balance -= principal;
                    schedule.push({
                        month: i,
                        payment: principal + interest,
                        principal: principal,
                        interest: interest,
                        balance: Math.max(0, balance)
                    });
                }
            } else {
                const monthlyRate = rate;
                const coefficient = Math.pow(1 + monthlyRate, term);
                const payment = amount * (monthlyRate * coefficient) / (coefficient - 1);
                
                for (let i = 1; i <= term; i++) {
                    const interest = balance * monthlyRate;
                    let principal = payment - interest;
                    if (principal < 0) principal = 0;
                    if (principal > balance) principal = balance;
                    balance -= principal;
                    schedule.push({
                        month: i,
                        payment: principal + interest,
                        principal: principal,
                        interest: interest,
                        balance: Math.max(0, balance)
                    });
                }
            }
            return schedule;
        }

        function calcLinear(amount, rate, term) {
            const schedule = [];
            const principalPerMonth = amount / term;
            let balance = amount;
            
            for (let i = 1; i <= term; i++) {
                const interest = balance * rate;
                const principal = (i === term) ? balance : principalPerMonth;
                balance = Math.max(0, balance - principal);
                schedule.push({
                    month: i,
                    payment: principal + interest,
                    principal: principal,
                    interest: interest,
                    balance: balance
                });
            }
            return schedule;
        }

        function calcDeclining(amount, rate, term, ratio) {
            let annuity;
            if (Math.abs(rate) < 1e-12) {
                annuity = amount / term;
            } else {
                const coeff = Math.pow(1 + rate, term);
                annuity = amount * (rate * coeff) / (coeff - 1);
            }
            
            let firstPayment = annuity * HIDDEN_ADMIN_PARAMS.decliningRatio;
            let lastPayment = firstPayment / ratio;
            let decrement = (term > 1) ? (firstPayment - lastPayment) / (term - 1) : 0;
            
            let bestFirst = firstPayment;
            let bestError = amount;
            
            for (let iter = 0; iter < 200; iter++) {
                let testBalance = amount;
                let valid = true;
                
                for (let m = 0; m < term; m++) {
                    const current = firstPayment - m * decrement;
                    const interest = testBalance * rate;
                    const principal = current - interest;
                    if (principal <= 0) { valid = false; break; }
                    testBalance -= principal;
                }
                
                if (valid) {
                    if (Math.abs(testBalance) < Math.abs(bestError)) {
                        bestError = testBalance;
                        bestFirst = firstPayment;
                    }
                    if (Math.abs(testBalance) < amount * 1e-6) break;
                    firstPayment *= (testBalance > 0) ? 1.001 : 0.999;
                } else {
                    firstPayment *= 1.001;
                }
                
                lastPayment = firstPayment / ratio;
                if (term > 1) decrement = (firstPayment - lastPayment) / (term - 1);
            }
            
            firstPayment = bestFirst;
            lastPayment = firstPayment / ratio;
            if (term > 1) decrement = (firstPayment - lastPayment) / (term - 1);
            
            const schedule = [];
            let balance = amount;
            
            for (let m = 1; m <= term; m++) {
                let payment = firstPayment - (m - 1) * decrement;
                const interest = balance * rate;
                let principal;
                
                if (m === term) {
                    principal = balance;
                    payment = principal + interest;
                    balance = 0;
                } else {
                    principal = payment - interest;
                    if (principal < 0) principal = 0;
                    if (principal > balance) principal = balance;
                    balance -= principal;
                }
                
                schedule.push({
                    month: m,
                    payment: payment,
                    principal: principal,
                    interest: interest,
                    balance: Math.max(0, balance)
                });
            }
            return schedule;
        }

        function calcQuarterlyAnnuity(amount, rate, term) {
            const monthly = calcAnnuity(amount, rate, term);
            const schedule = [];
            
            let accPayment = 0, accPrincipal = 0, accInterest = 0;
            let balance = amount;
            
            for (let i = 0; i < term; i++) {
                const month = monthly[i];
                accPayment += month.payment;
                accPrincipal += month.principal;
                accInterest += month.interest;
                balance -= month.principal;
                if (balance < 0) balance = 0;
                
                const isQuarterEnd = ((i + 1) % 3 === 0) || (i + 1 === term);
                
                if (isQuarterEnd) {
                    schedule.push({
                        month: i + 1,
                        payment: accPayment,
                        principal: accPrincipal,
                        interest: accInterest,
                        balance: balance
                    });
                    accPayment = accPrincipal = accInterest = 0;
                } else {
                    schedule.push({
                        month: i + 1,
                        payment: null,
                        principal: null,
                        interest: month.interest,
                        balance: balance
                    });
                }
            }
            return schedule;
        }

        function calcQuarterlyLinear(amount, rate, term) {
            const schedule = [];
            const quarters = Math.ceil(term / 3);
            const principalPerQuarter = amount / quarters;
            let balance = amount;
            
            for (let i = 1; i <= term; i++) {
                const interest = balance * rate;
                const isQuarterEnd = (i % 3 === 0) || (i === term);
                
                if (isQuarterEnd) {
                    let principal = (i === term) ? balance : principalPerQuarter;
                    const payment = principal + interest * 3;
                    balance -= principal;
                    if (balance < 0) balance = 0;
                    
                    schedule.push({
                        month: i,
                        payment: payment,
                        principal: principal,
                        interest: interest,
                        balance: balance
                    });
                } else {
                    schedule.push({
                        month: i,
                        payment: null,
                        principal: null,
                        interest: interest,
                        balance: balance
                    });
                }
            }
            return schedule;
        }

        function calcInstallmentMonthly(amount, term) {
            const schedule = [];
            const payment = amount / term;
            let balance = amount;
            
            for (let i = 1; i <= term; i++) {
                const principal = (i === term) ? balance : payment;
                balance -= principal;
                if (balance < 0) balance = 0;
                
                schedule.push({
                    month: i,
                    payment: principal,
                    principal: principal,
                    interest: 0,
                    balance: balance
                });
            }
            return schedule;
        }

        function calcInstallmentQuarterly(amount, term) {
            const monthly = calcInstallmentMonthly(amount, term);
            const schedule = [];
            
            let accPayment = 0;
            let actualBalance = amount;
            let displayBalance = amount;
            
            for (let i = 0; i < term; i++) {
                accPayment += monthly[i].payment;
                actualBalance -= monthly[i].payment;
                if (actualBalance < 0) actualBalance = 0;
                
                const isQuarterEnd = ((i + 1) % 3 === 0) || (i + 1 === term);
                
                if (isQuarterEnd) {
                    displayBalance = actualBalance;
                    schedule.push({
                        month: i + 1,
                        payment: accPayment,
                        principal: accPayment,
                        interest: null,
                        balance: displayBalance
                    });
                    accPayment = 0;
                } else {
                    schedule.push({
                        month: i + 1,
                        payment: null,
                        principal: null,
                        interest: null,
                        balance: null
                    });
                }
            }
            return schedule;
        }

        function getScheduleByType(type, amount, rate, term) {
            switch(type) {
                case 'annuity': return calcAnnuity(amount, rate, term);
                case 'linear': return calcLinear(amount, rate, term);
                case 'declining2x': return calcDeclining(amount, rate, term, 2);
                case 'declining3x': return calcDeclining(amount, rate, term, 3);
                case 'quarterly_annuity': return calcQuarterlyAnnuity(amount, rate, term);
                case 'quarterly_linear': return calcQuarterlyLinear(amount, rate, term);
                case 'installment_monthly': return calcInstallmentMonthly(amount, term);
                case 'installment_quarterly': return calcInstallmentQuarterly(amount, term);
                default: return calcAnnuity(amount, rate, term);
            }
        }

        // ========== ОСНОВНАЯ ЛОГИКА ==========
        let elements = {};

        function initApp() {
            // Получаем элементы
            elements = {
                totalPrice: document.getElementById('totalPrice'),
                advancePercent: document.getElementById('advancePercent'),
                discount: document.getElementById('discount'),
                requestedMonths: document.getElementById('requestedMonths'),
                term: document.getElementById('term'),
                extraPayment: document.getElementById('extraPayment'),
                paymentType: document.getElementById('paymentType'),
                calculateBtn: document.getElementById('calculateBtn'),
                loader: document.getElementById('loader'),
                leasingAmount: document.getElementById('leasingAmount'),
                advanceAmount: document.getElementById('advanceAmount'),
                totalOverpayment: document.getElementById('totalOverpayment'),
                effectiveRate: document.getElementById('effectiveRate'),
                scheduleBody: document.getElementById('scheduleBody'),
                irrSection: document.getElementById('irrSection'),
                monthlyIRR: document.getElementById('monthlyIRR'),
                annualIRR: document.getElementById('annualIRR')
            };
            
            // Настраиваем автоформатирование
            setupAutoFormat();
            
            // Назначаем обработчики
            setupEventListeners();
            
            // Первый расчет
            calculateLeasing();
        }

        function setupAutoFormat() {
            document.querySelectorAll('.currency-input input').forEach(input => {
                input.addEventListener('input', function(e) {
                    const cursorPos = this.selectionStart;
                    const originalValue = this.value.replace(/\s/g, '');
                    
                    if (originalValue === '') {
                        this.value = '';
                        return;
                    }
                    
                    if (!isNaN(parseFloat(originalValue))) {
                        const formatted = formatNumber(parseFloat(originalValue));
                        this.value = formatted;
                        const diff = formatted.length - this.value.length;
                        this.setSelectionRange(cursorPos + diff, cursorPos + diff);
                    }
                });
            });
        }

        function setupEventListeners() {
            elements.calculateBtn.addEventListener('click', calculateLeasing);
            
            ['totalPrice', 'advancePercent', 'discount', 'requestedMonths', 'term', 'extraPayment', 'paymentType']
                .forEach(id => {
                    document.getElementById(id).addEventListener('change', calculateLeasing);
                });
        }

        function calculateLeasing() {
            elements.loader.classList.add('active');
            
            setTimeout(() => {
                try {
                    const totalPrice = parseFormattedNumber(elements.totalPrice.value);
                    const advancePercent = normalizePercent(elements.advancePercent.value);
                    const discount = parseFormattedNumber(elements.discount.value);
                    const requestedMonths = parseInt(elements.requestedMonths.value);
                    const term = parseInt(elements.term.value);
                    const extraPayment = parseFormattedNumber(elements.extraPayment.value);
                    const paymentType = elements.paymentType.value;
                    
                    // Валидация
                    if (totalPrice <= 0 || isNaN(totalPrice)) {
                        alert('Стоимость имущества должна быть положительным числом');
                        return;
                    }
                    
                    if (requestedMonths < 3 || requestedMonths > 13) {
                        alert('Период рассрочки должен быть от 3 до 13 месяцев');
                        return;
                    }
                    
                    if (term <= 0 || isNaN(term)) {
                        alert('Срок лизинга должен быть положительным числом');
                        return;
                    }
                    
                    // Расчет основных значений
                    const advanceAmount = totalPrice * advancePercent;
                    const leasingAmount = totalPrice - advanceAmount;
                    
                    // Общая ставка (из скрытых параметров)
                    const totalAnnualRate = HIDDEN_ADMIN_PARAMS.leasingRate + 
                                           HIDDEN_ADMIN_PARAMS.insuranceRate + 
                                           HIDDEN_ADMIN_PARAMS.marginRate;
                    const monthlyRate = totalAnnualRate / 12;
                    
                    // График платежей
                    const schedule = getScheduleByType(paymentType, leasingAmount, monthlyRate, term);
                    const isInstallment = paymentType.includes('installment');
                    
                    // Дополнительный платеж
                    if (extraPayment > 0) {
                        schedule.forEach(item => {
                            if (item.payment !== null) item.payment += extraPayment;
                        });
                    }
                    
                    // Итоги
                    let totalInterest = 0;
                    schedule.forEach(item => {
                        if (item.interest !== null) totalInterest += item.interest;
                    });
                    
                    let effectiveRate = 0;
                    if (!isInstallment) {
                        effectiveRate = totalInterest / (leasingAmount * (term / 12));
                    }
                    
                    // IRR для короткой рассрочки (только показываем, без проверки)
                    const monthlyPaymentForIRR = leasingAmount / requestedMonths;
                    const irrResult = analyzeIRR(totalPrice, advanceAmount, discount, requestedMonths, monthlyPaymentForIRR);
                    
                    // Обновление интерфейса
                    updateDisplay(leasingAmount, advanceAmount, totalInterest, effectiveRate, schedule, irrResult);
                    
                    elements.loader.classList.remove('active');
                    
                } catch (error) {
                    alert('Ошибка расчета: ' + error.message);
                    elements.loader.classList.remove('active');
                }
            }, 300);
        }

        function updateDisplay(leasingAmount, advanceAmount, totalInterest, effectiveRate, schedule, irrResult) {
            // Итоговые значения
            elements.leasingAmount.textContent = formatNumber(leasingAmount);
            elements.advanceAmount.textContent = formatNumber(advanceAmount);
            elements.totalOverpayment.textContent = formatNumber(totalInterest);
            elements.effectiveRate.textContent = (effectiveRate * 100).toFixed(2);
            
            // IRR секция (всегда показываем для 3-13 месяцев)
            const isShortTerm = elements.requestedMonths.value <= 13;
            if (isShortTerm && irrResult) {
                elements.irrSection.classList.remove('hidden');
                elements.monthlyIRR.textContent = (irrResult.monthlyIRR * 100).toFixed(4);
                elements.annualIRR.textContent = (irrResult.annualIRR * 100).toFixed(2);
                
                // Убрали подсветку, просто показываем значение
                elements.irrSection.style.backgroundColor = '';
                elements.irrSection.style.border = '';
            } else {
                elements.irrSection.classList.add('hidden');
            }
            
            // Таблица платежей
            elements.scheduleBody.innerHTML = '';
            
            if (schedule.length === 0) {
                elements.scheduleBody.innerHTML = '<tr><td colspan="5">Нет данных для отображения</td></tr>';
                return;
            }
            
            schedule.forEach(item => {
                const row = document.createElement('tr');
                
                const monthCell = document.createElement('td');
                monthCell.textContent = item.month;
                row.appendChild(monthCell);
                
                const paymentCell = document.createElement('td');
                paymentCell.textContent = item.payment !== null ? formatNumber(item.payment) : '-';
                paymentCell.style.fontWeight = 'bold';
                row.appendChild(paymentCell);
                
                const principalCell = document.createElement('td');
                principalCell.textContent = item.principal !== null ? formatNumber(item.principal) : '-';
                row.appendChild(principalCell);
                
                const interestCell = document.createElement('td');
                interestCell.textContent = item.interest !== null ? formatNumber(item.interest) : '-';
                row.appendChild(interestCell);
                
                const balanceCell = document.createElement('td');
                balanceCell.textContent = item.balance !== null ? formatNumber(item.balance) : '-';
                row.appendChild(balanceCell);
                
                elements.scheduleBody.appendChild(row);
            });
        }

        // Запуск приложения
        window.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
